{
  "url": "https://microsoft.github.io/autogen/stable/user-guide/agentchat-user-guide/tutorial/state.html",
  "title": "Managing State â€” AutoGen",
  "content": "So far, we have discussed how to build components in a multi-agent application - agents, teams, termination conditions. In many cases, it is useful to save the state of these components to disk and load them back later. This is particularly useful in a web application where stateless endpoints respond to requests and need to load the state of the application from persistent storage.\n\nIn this notebook, we will discuss how to save and load the state of agents, teams, and termination conditions.\n\nWe can get the state of an agent by calling save_state() method on an AssistantAgent.\n\nFor AssistantAgent, its state consists of the model_context. If you write your own custom agent, consider overriding the save_state() and load_state() methods to customize the behavior. The default implementations save and load an empty state.\n\nWe can get the state of a team by calling save_state method on the team and load it back by calling load_state method on the team.\n\nWhen we call save_state on a team, it saves the state of all the agents in the team.\n\nWe will begin by creating a simple RoundRobinGroupChat team with a single agent and ask it to write a poem.\n\nIf we reset the team (simulating instantiation of the team), and ask the question What was the last line of the poem you wrote?, we see that the team is unable to accomplish this as there is no reference to the previous run.\n\nNext, we load the state of the team and ask the same question. We see that the team is able to accurately return the last line of the poem it wrote.\n\nIn many cases, we may want to persist the state of the team to disk (or a database) and load it back later. State is a dictionary that can be serialized to a file or written to a database.",
  "headings": [
    {
      "level": "h1",
      "text": "Managing State#",
      "id": ""
    },
    {
      "level": "h2",
      "text": "Saving and Loading Agents#",
      "id": ""
    },
    {
      "level": "h2",
      "text": "Saving and Loading Teams#",
      "id": ""
    },
    {
      "level": "h2",
      "text": "Persisting State (File or Database)#",
      "id": ""
    }
  ],
  "code_samples": [
    {
      "code": "from autogen_agentchat.agents import AssistantAgent\nfrom autogen_agentchat.conditions import MaxMessageTermination\nfrom autogen_agentchat.messages import TextMessage\nfrom autogen_agentchat.teams import RoundRobinGroupChat\nfrom autogen_agentchat.ui import Console\nfrom autogen_core import CancellationToken\nfrom autogen_ext.models.openai import OpenAIChatCompletionClient\n\nmodel_client = OpenAIChatCompletionClient(model=\"gpt-4o-2024-08-06\")\n\nassistant_agent = AssistantAgent(\n    name=\"assistant_agent\",\n    system_message=\"You are a helpful assistant\",\n    model_client=model_client,\n)\n\n# Use asyncio.run(...) when running in a script.\nresponse = await assistant_agent.on_messages(\n    [TextMessage(content=\"Write a 3 line poem on lake tangayika\", source=\"user\")], CancellationToken()\n)\nprint(response.chat_message)\nawait model_client.close()",
      "language": "python"
    },
    {
      "code": "from autogen_agentchat.agents import AssistantAgent\nfrom autogen_agentchat.conditions import MaxMessageTermination\nfrom autogen_agentchat.messages import TextMessage\nfrom autogen_agentchat.teams import RoundRobinGroupChat\nfrom autogen_agentchat.ui import Console\nfrom autogen_core import CancellationToken\nfrom autogen_ext.models.openai import OpenAIChatCompletionClient\n\nmodel_client = OpenAIChatCompletionClient(model=\"gpt-4o-2024-08-06\")\n\nassistant_agent = AssistantAgent(\n    name=\"assistant_agent\",\n    system_message=\"You are a helpful assistant\",\n    model_client=model_client,\n)\n\n# Use asyncio.run(...) when running in a script.\nresponse = await assistant_agent.on_messages(\n    [TextMessage(content=\"Write a 3 line poem on lake tangayika\", source=\"user\")], CancellationToken()\n)\nprint(response.chat_message)\nawait model_client.close()",
      "language": "python"
    },
    {
      "code": "In Tanganyika's embrace so wide and deep,  \nAncient waters cradle secrets they keep,  \nEchoes of time where horizons sleep.",
      "language": "sql"
    },
    {
      "code": "In Tanganyika's embrace so wide and deep,  \nAncient waters cradle secrets they keep,  \nEchoes of time where horizons sleep.",
      "language": "sql"
    },
    {
      "code": "agent_state = await assistant_agent.save_state()\nprint(agent_state)",
      "language": "python"
    },
    {
      "code": "agent_state = await assistant_agent.save_state()\nprint(agent_state)",
      "language": "python"
    },
    {
      "code": "{'type': 'AssistantAgentState', 'version': '1.0.0', 'llm_messages': [{'content': 'Write a 3 line poem on lake tangayika', 'source': 'user', 'type': 'UserMessage'}, {'content': \"In Tanganyika's embrace so wide and deep,  \\nAncient waters cradle secrets they keep,  \\nEchoes of time where horizons sleep.  \", 'source': 'assistant_agent', 'type': 'AssistantMessage'}]}",
      "language": "json"
    },
    {
      "code": "{'type': 'AssistantAgentState', 'version': '1.0.0', 'llm_messages': [{'content': 'Write a 3 line poem on lake tangayika', 'source': 'user', 'type': 'UserMessage'}, {'content': \"In Tanganyika's embrace so wide and deep,  \\nAncient waters cradle secrets they keep,  \\nEchoes of time where horizons sleep.  \", 'source': 'assistant_agent', 'type': 'AssistantMessage'}]}",
      "language": "json"
    },
    {
      "code": "model_client = OpenAIChatCompletionClient(model=\"gpt-4o-2024-08-06\")\n\nnew_assistant_agent = AssistantAgent(\n    name=\"assistant_agent\",\n    system_message=\"You are a helpful assistant\",\n    model_client=model_client,\n)\nawait new_assistant_agent.load_state(agent_state)\n\n# Use asyncio.run(...) when running in a script.\nresponse = await new_assistant_agent.on_messages(\n    [TextMessage(content=\"What was the last line of the previous poem you wrote\", source=\"user\")], CancellationToken()\n)\nprint(response.chat_message)\nawait model_client.close()",
      "language": "python"
    },
    {
      "code": "model_client = OpenAIChatCompletionClient(model=\"gpt-4o-2024-08-06\")\n\nnew_assistant_agent = AssistantAgent(\n    name=\"assistant_agent\",\n    system_message=\"You are a helpful assistant\",\n    model_client=model_client,\n)\nawait new_assistant_agent.load_state(agent_state)\n\n# Use asyncio.run(...) when running in a script.\nresponse = await new_assistant_agent.on_messages(\n    [TextMessage(content=\"What was the last line of the previous poem you wrote\", source=\"user\")], CancellationToken()\n)\nprint(response.chat_message)\nawait model_client.close()",
      "language": "python"
    },
    {
      "code": "The last line of the poem was: \"Echoes of time where horizons sleep.\"",
      "language": "sql"
    },
    {
      "code": "The last line of the poem was: \"Echoes of time where horizons sleep.\"",
      "language": "sql"
    },
    {
      "code": "model_client = OpenAIChatCompletionClient(model=\"gpt-4o-2024-08-06\")\n\n# Define a team.\nassistant_agent = AssistantAgent(\n    name=\"assistant_agent\",\n    system_message=\"You are a helpful assistant\",\n    model_client=model_client,\n)\nagent_team = RoundRobinGroupChat([assistant_agent], termination_condition=MaxMessageTermination(max_messages=2))\n\n# Run the team and stream messages to the console.\nstream = agent_team.run_stream(task=\"Write a beautiful poem 3-line about lake tangayika\")\n\n# Use asyncio.run(...) when running in a script.\nawait Console(stream)\n\n# Save the state of the agent team.\nteam_state = await agent_team.save_state()",
      "language": "markdown"
    },
    {
      "code": "model_client = OpenAIChatCompletionClient(model=\"gpt-4o-2024-08-06\")\n\n# Define a team.\nassistant_agent = AssistantAgent(\n    name=\"assistant_agent\",\n    system_message=\"You are a helpful assistant\",\n    model_client=model_client,\n)\nagent_team = RoundRobinGroupChat([assistant_agent], termination_condition=MaxMessageTermination(max_messages=2))\n\n# Run the team and stream messages to the console.\nstream = agent_team.run_stream(task=\"Write a beautiful poem 3-line about lake tangayika\")\n\n# Use asyncio.run(...) when running in a script.\nawait Console(stream)\n\n# Save the state of the agent team.\nteam_state = await agent_team.save_state()",
      "language": "markdown"
    },
    {
      "code": "---------- user ----------\nWrite a beautiful poem 3-line about lake tangayika\n---------- assistant_agent ----------\nIn Tanganyika's gleam, beneath the azure skies,  \nWhispers of ancient waters, in tranquil guise,  \nNature's mirror, where dreams and serenity lie.\n[Prompt tokens: 29, Completion tokens: 34]\n---------- Summary ----------\nNumber of messages: 2\nFinish reason: Maximum number of messages 2 reached, current message count: 2\nTotal prompt tokens: 29\nTotal completion tokens: 34\nDuration: 0.71 seconds",
      "language": "json"
    },
    {
      "code": "---------- user ----------\nWrite a beautiful poem 3-line about lake tangayika\n---------- assistant_agent ----------\nIn Tanganyika's gleam, beneath the azure skies,  \nWhispers of ancient waters, in tranquil guise,  \nNature's mirror, where dreams and serenity lie.\n[Prompt tokens: 29, Completion tokens: 34]\n---------- Summary ----------\nNumber of messages: 2\nFinish reason: Maximum number of messages 2 reached, current message count: 2\nTotal prompt tokens: 29\nTotal completion tokens: 34\nDuration: 0.71 seconds",
      "language": "json"
    },
    {
      "code": "await agent_team.reset()\nstream = agent_team.run_stream(task=\"What was the last line of the poem you wrote?\")\nawait Console(stream)",
      "language": "csharp"
    },
    {
      "code": "await agent_team.reset()\nstream = agent_team.run_stream(task=\"What was the last line of the poem you wrote?\")\nawait Console(stream)",
      "language": "csharp"
    },
    {
      "code": "---------- user ----------\nWhat was the last line of the poem you wrote?\n---------- assistant_agent ----------\nI'm sorry, but I am unable to recall or access previous interactions, including any specific poem I may have composed in our past conversations. If you like, I can write a new poem for you.\n[Prompt tokens: 28, Completion tokens: 40]\n---------- Summary ----------\nNumber of messages: 2\nFinish reason: Maximum number of messages 2 reached, current message count: 2\nTotal prompt tokens: 28\nTotal completion tokens: 40\nDuration: 0.70 seconds",
      "language": "json"
    },
    {
      "code": "---------- user ----------\nWhat was the last line of the poem you wrote?\n---------- assistant_agent ----------\nI'm sorry, but I am unable to recall or access previous interactions, including any specific poem I may have composed in our past conversations. If you like, I can write a new poem for you.\n[Prompt tokens: 28, Completion tokens: 40]\n---------- Summary ----------\nNumber of messages: 2\nFinish reason: Maximum number of messages 2 reached, current message count: 2\nTotal prompt tokens: 28\nTotal completion tokens: 40\nDuration: 0.70 seconds",
      "language": "json"
    },
    {
      "code": "TaskResult(messages=[TextMessage(source='user', models_usage=None, content='What was the last line of the poem you wrote?', type='TextMessage'), TextMessage(source='assistant_agent', models_usage=RequestUsage(prompt_tokens=28, completion_tokens=40), content=\"I'm sorry, but I am unable to recall or access previous interactions, including any specific poem I may have composed in our past conversations. If you like, I can write a new poem for you.\", type='TextMessage')], stop_reason='Maximum number of messages 2 reached, current message count: 2')",
      "language": "rust"
    },
    {
      "code": "TaskResult(messages=[TextMessage(source='user', models_usage=None, content='What was the last line of the poem you wrote?', type='TextMessage'), TextMessage(source='assistant_agent', models_usage=RequestUsage(prompt_tokens=28, completion_tokens=40), content=\"I'm sorry, but I am unable to recall or access previous interactions, including any specific poem I may have composed in our past conversations. If you like, I can write a new poem for you.\", type='TextMessage')], stop_reason='Maximum number of messages 2 reached, current message count: 2')",
      "language": "rust"
    },
    {
      "code": "print(team_state)\n\n# Load team state.\nawait agent_team.load_state(team_state)\nstream = agent_team.run_stream(task=\"What was the last line of the poem you wrote?\")\nawait Console(stream)",
      "language": "python"
    },
    {
      "code": "print(team_state)\n\n# Load team state.\nawait agent_team.load_state(team_state)\nstream = agent_team.run_stream(task=\"What was the last line of the poem you wrote?\")\nawait Console(stream)",
      "language": "python"
    },
    {
      "code": "{'type': 'TeamState', 'version': '1.0.0', 'agent_states': {'group_chat_manager/a55364ad-86fd-46ab-9449-dcb5260b1e06': {'type': 'RoundRobinManagerState', 'version': '1.0.0', 'message_thread': [{'source': 'user', 'models_usage': None, 'content': 'Write a beautiful poem 3-line about lake tangayika', 'type': 'TextMessage'}, {'source': 'assistant_agent', 'models_usage': {'prompt_tokens': 29, 'completion_tokens': 34}, 'content': \"In Tanganyika's gleam, beneath the azure skies,  \\nWhispers of ancient waters, in tranquil guise,  \\nNature's mirror, where dreams and serenity lie.\", 'type': 'TextMessage'}], 'current_turn': 0, 'next_speaker_index': 0}, 'collect_output_messages/a55364ad-86fd-46ab-9449-dcb5260b1e06': {}, 'assistant_agent/a55364ad-86fd-46ab-9449-dcb5260b1e06': {'type': 'ChatAgentContainerState', 'version': '1.0.0', 'agent_state': {'type': 'AssistantAgentState', 'version': '1.0.0', 'llm_messages': [{'content': 'Write a beautiful poem 3-line about lake tangayika', 'source': 'user', 'type': 'UserMessage'}, {'content': \"In Tanganyika's gleam, beneath the azure skies,  \\nWhispers of ancient waters, in tranquil guise,  \\nNature's mirror, where dreams and serenity lie.\", 'source': 'assistant_agent', 'type': 'AssistantMessage'}]}, 'message_buffer': []}}, 'team_id': 'a55364ad-86fd-46ab-9449-dcb5260b1e06'}\n---------- user ----------\nWhat was the last line of the poem you wrote?\n---------- assistant_agent ----------\nThe last line of the poem I wrote is:  \n\"Nature's mirror, where dreams and serenity lie.\"\n[Prompt tokens: 86, Completion tokens: 22]\n---------- Summary ----------\nNumber of messages: 2\nFinish reason: Maximum number of messages 2 reached, current message count: 2\nTotal prompt tokens: 86\nTotal completion tokens: 22\nDuration: 0.96 seconds",
      "language": "json"
    },
    {
      "code": "{'type': 'TeamState', 'version': '1.0.0', 'agent_states': {'group_chat_manager/a55364ad-86fd-46ab-9449-dcb5260b1e06': {'type': 'RoundRobinManagerState', 'version': '1.0.0', 'message_thread': [{'source': 'user', 'models_usage': None, 'content': 'Write a beautiful poem 3-line about lake tangayika', 'type': 'TextMessage'}, {'source': 'assistant_agent', 'models_usage': {'prompt_tokens': 29, 'completion_tokens': 34}, 'content': \"In Tanganyika's gleam, beneath the azure skies,  \\nWhispers of ancient waters, in tranquil guise,  \\nNature's mirror, where dreams and serenity lie.\", 'type': 'TextMessage'}], 'current_turn': 0, 'next_speaker_index': 0}, 'collect_output_messages/a55364ad-86fd-46ab-9449-dcb5260b1e06': {}, 'assistant_agent/a55364ad-86fd-46ab-9449-dcb5260b1e06': {'type': 'ChatAgentContainerState', 'version': '1.0.0', 'agent_state': {'type': 'AssistantAgentState', 'version': '1.0.0', 'llm_messages': [{'content': 'Write a beautiful poem 3-line about lake tangayika', 'source': 'user', 'type': 'UserMessage'}, {'content': \"In Tanganyika's gleam, beneath the azure skies,  \\nWhispers of ancient waters, in tranquil guise,  \\nNature's mirror, where dreams and serenity lie.\", 'source': 'assistant_agent', 'type': 'AssistantMessage'}]}, 'message_buffer': []}}, 'team_id': 'a55364ad-86fd-46ab-9449-dcb5260b1e06'}\n---------- user ----------\nWhat was the last line of the poem you wrote?\n---------- assistant_agent ----------\nThe last line of the poem I wrote is:  \n\"Nature's mirror, where dreams and serenity lie.\"\n[Prompt tokens: 86, Completion tokens: 22]\n---------- Summary ----------\nNumber of messages: 2\nFinish reason: Maximum number of messages 2 reached, current message count: 2\nTotal prompt tokens: 86\nTotal completion tokens: 22\nDuration: 0.96 seconds",
      "language": "json"
    },
    {
      "code": "TaskResult(messages=[TextMessage(source='user', models_usage=None, content='What was the last line of the poem you wrote?', type='TextMessage'), TextMessage(source='assistant_agent', models_usage=RequestUsage(prompt_tokens=86, completion_tokens=22), content='The last line of the poem I wrote is:  \\n\"Nature\\'s mirror, where dreams and serenity lie.\"', type='TextMessage')], stop_reason='Maximum number of messages 2 reached, current message count: 2')",
      "language": "rust"
    },
    {
      "code": "TaskResult(messages=[TextMessage(source='user', models_usage=None, content='What was the last line of the poem you wrote?', type='TextMessage'), TextMessage(source='assistant_agent', models_usage=RequestUsage(prompt_tokens=86, completion_tokens=22), content='The last line of the poem I wrote is:  \\n\"Nature\\'s mirror, where dreams and serenity lie.\"', type='TextMessage')], stop_reason='Maximum number of messages 2 reached, current message count: 2')",
      "language": "rust"
    },
    {
      "code": "import json\n\n## save state to disk\n\nwith open(\"coding/team_state.json\", \"w\") as f:\n    json.dump(team_state, f)\n\n## load state from disk\nwith open(\"coding/team_state.json\", \"r\") as f:\n    team_state = json.load(f)\n\nnew_agent_team = RoundRobinGroupChat([assistant_agent], termination_condition=MaxMessageTermination(max_messages=2))\nawait new_agent_team.load_state(team_state)\nstream = new_agent_team.run_stream(task=\"What was the last line of the poem you wrote?\")\nawait Console(stream)\nawait model_client.close()",
      "language": "typescript"
    },
    {
      "code": "import json\n\n## save state to disk\n\nwith open(\"coding/team_state.json\", \"w\") as f:\n    json.dump(team_state, f)\n\n## load state from disk\nwith open(\"coding/team_state.json\", \"r\") as f:\n    team_state = json.load(f)\n\nnew_agent_team = RoundRobinGroupChat([assistant_agent], termination_condition=MaxMessageTermination(max_messages=2))\nawait new_agent_team.load_state(team_state)\nstream = new_agent_team.run_stream(task=\"What was the last line of the poem you wrote?\")\nawait Console(stream)\nawait model_client.close()",
      "language": "typescript"
    },
    {
      "code": "---------- user ----------\nWhat was the last line of the poem you wrote?\n---------- assistant_agent ----------\nThe last line of the poem I wrote is:  \n\"Nature's mirror, where dreams and serenity lie.\"\n[Prompt tokens: 86, Completion tokens: 22]\n---------- Summary ----------\nNumber of messages: 2\nFinish reason: Maximum number of messages 2 reached, current message count: 2\nTotal prompt tokens: 86\nTotal completion tokens: 22\nDuration: 0.72 seconds",
      "language": "json"
    },
    {
      "code": "---------- user ----------\nWhat was the last line of the poem you wrote?\n---------- assistant_agent ----------\nThe last line of the poem I wrote is:  \n\"Nature's mirror, where dreams and serenity lie.\"\n[Prompt tokens: 86, Completion tokens: 22]\n---------- Summary ----------\nNumber of messages: 2\nFinish reason: Maximum number of messages 2 reached, current message count: 2\nTotal prompt tokens: 86\nTotal completion tokens: 22\nDuration: 0.72 seconds",
      "language": "json"
    },
    {
      "code": "TaskResult(messages=[TextMessage(source='user', models_usage=None, content='What was the last line of the poem you wrote?', type='TextMessage'), TextMessage(source='assistant_agent', models_usage=RequestUsage(prompt_tokens=86, completion_tokens=22), content='The last line of the poem I wrote is:  \\n\"Nature\\'s mirror, where dreams and serenity lie.\"', type='TextMessage')], stop_reason='Maximum number of messages 2 reached, current message count: 2')",
      "language": "rust"
    },
    {
      "code": "TaskResult(messages=[TextMessage(source='user', models_usage=None, content='What was the last line of the poem you wrote?', type='TextMessage'), TextMessage(source='assistant_agent', models_usage=RequestUsage(prompt_tokens=86, completion_tokens=22), content='The last line of the poem I wrote is:  \\n\"Nature\\'s mirror, where dreams and serenity lie.\"', type='TextMessage')], stop_reason='Maximum number of messages 2 reached, current message count: 2')",
      "language": "rust"
    }
  ],
  "patterns": [],
  "links": [
    "https://microsoft.github.io/autogen/stable/user-guide/agentchat-user-guide/tutorial/state.html",
    "https://microsoft.github.io/autogen/stable/index.html",
    "https://microsoft.github.io/autogen/stable/user-guide/agentchat-user-guide/index.html",
    "https://microsoft.github.io/autogen/stable/user-guide/core-user-guide/index.html",
    "https://microsoft.github.io/autogen/stable/user-guide/extensions-user-guide/index.html",
    "https://microsoft.github.io/autogen/stable/user-guide/autogenstudio-user-guide/index.html",
    "https://microsoft.github.io/autogen/stable/reference/index.html",
    "https://microsoft.github.io/autogen/stable/user-guide/agentchat-user-guide/installation.html",
    "https://microsoft.github.io/autogen/stable/user-guide/agentchat-user-guide/quickstart.html",
    "https://microsoft.github.io/autogen/stable/user-guide/agentchat-user-guide/migration-guide.html",
    "https://microsoft.github.io/autogen/stable/user-guide/agentchat-user-guide/tutorial/index.html",
    "https://microsoft.github.io/autogen/stable/user-guide/agentchat-user-guide/tutorial/models.html",
    "https://microsoft.github.io/autogen/stable/user-guide/agentchat-user-guide/tutorial/messages.html",
    "https://microsoft.github.io/autogen/stable/user-guide/agentchat-user-guide/tutorial/agents.html",
    "https://microsoft.github.io/autogen/stable/user-guide/agentchat-user-guide/tutorial/teams.html",
    "https://microsoft.github.io/autogen/stable/user-guide/agentchat-user-guide/tutorial/human-in-the-loop.html",
    "https://microsoft.github.io/autogen/stable/user-guide/agentchat-user-guide/tutorial/termination.html",
    "https://microsoft.github.io/autogen/stable/user-guide/agentchat-user-guide/custom-agents.html",
    "https://microsoft.github.io/autogen/stable/user-guide/agentchat-user-guide/selector-group-chat.html",
    "https://microsoft.github.io/autogen/stable/user-guide/agentchat-user-guide/swarm.html",
    "https://microsoft.github.io/autogen/stable/user-guide/agentchat-user-guide/magentic-one.html",
    "https://microsoft.github.io/autogen/stable/user-guide/agentchat-user-guide/graph-flow.html",
    "https://microsoft.github.io/autogen/stable/user-guide/agentchat-user-guide/memory.html",
    "https://microsoft.github.io/autogen/stable/user-guide/agentchat-user-guide/logging.html",
    "https://microsoft.github.io/autogen/stable/user-guide/agentchat-user-guide/serialize-components.html",
    "https://microsoft.github.io/autogen/stable/user-guide/agentchat-user-guide/tracing.html",
    "https://microsoft.github.io/autogen/stable/user-guide/agentchat-user-guide/examples/index.html",
    "https://microsoft.github.io/autogen/stable/user-guide/agentchat-user-guide/examples/travel-planning.html",
    "https://microsoft.github.io/autogen/stable/user-guide/agentchat-user-guide/examples/company-research.html",
    "https://microsoft.github.io/autogen/stable/user-guide/agentchat-user-guide/examples/literature-review.html",
    "https://microsoft.github.io/autogen/stable/reference/python/autogen_agentchat.html",
    "https://microsoft.github.io/autogen/stable/reference/python/autogen_agentchat.agents.html",
    "https://microsoft.github.io/autogen/stable/reference/python/autogen_agentchat.teams.html"
  ]
}