{
  "title": "Troubleshoot trace nesting",
  "content": "Source: https://docs.langchain.com/langsmith/nest-traces\n\nWhen tracing with the LangSmith SDK, LangGraph, and LangChain, tracing should automatically propagate the correct context so that code executed within a parent trace will be rendered in the expected location in the UI.\n\nIf you see a child run go to a separate trace (and appear on the top level), it may be caused by one of the following known \"edge cases\".\n\nThe following outlines common causes for \"split\" traces when building with python.\n\n### Context propagation using asyncio\n\nWhen using async calls (especially with streaming) in Python versions \\< 3.11, you may encounter issues with trace nesting. This is because Python's `asyncio` only [added full support for passing context](https://docs.python.org/3/library/asyncio-task.html#asyncio.create_task) in version 3.11.\n\nLangChain and LangSmith SDK use [contextvars](https://docs.python.org/3/library/contextvars.html) to propagate tracing information implicitly. In Python 3.11 and above, this works seamlessly. However, in earlier versions (3.8, 3.9, 3.10), `asyncio` tasks lack proper `contextvar` support, which can lead to disconnected traces.\n\n1. **Upgrade Python Version (Recommended)** If possible, upgrade to Python 3.11 or later for automatic context propagation.\n\n2. **Manual Context Propagation** If upgrading isn't an option, you'll need to manually propagate the tracing context. The method varies depending on your setup:\n\na) **Using LangGraph or LangChain** Pass the parent `config` to the child call:\n\nb) **Using LangSmith Directly** Pass the run tree directly:\n\nc) **Combining Decorated Code with LangGraph/LangChain** Use a combination of techniques for manual handoff:\n\n### Context propagation using threading\n\nIt's common to start tracing and want to apply some parallelism on child tasks all within a single trace. Python's stdlib `ThreadPoolExecutor` by default breaks tracing.\n\nPython's contextvars start empty within new threads. Here are two approaches to handle maintain trace contiguity:\n\n1. **Using LangSmith's ContextThreadPoolExecutor**\n\nLangSmith provides a `ContextThreadPoolExecutor` that automatically handles context propagation:\n\n2. **Manually providing the parent run tree**\n\nAlternatively, you can manually pass the parent run tree to the inner function:\n\nIn this approach, we use `get_current_run_tree()` to obtain the current run tree and pass it to the inner function using the `langsmith_extra` parameter.\n\nBoth methods ensure that the inner function calls are correctly aggregated under the initial trace stack, even when executed in separate threads.\n\n<Callout icon=\"pen-to-square\" iconType=\"regular\">\n  [Edit this page on GitHub](https://github.com/langchain-ai/docs/edit/main/src/langsmith/nest-traces.mdx) or [file an issue](https://github.com/langchain-ai/docs/issues/new/choose).\n</Callout>\n\n<Tip icon=\"terminal\" iconType=\"regular\">\n  [Connect these docs](/use-these-docs) to Claude, VSCode, and more via MCP for real-time answers.\n</Tip>",
  "code_samples": [
    {
      "code": "b) **Using LangSmith Directly** Pass the run tree directly:",
      "language": "unknown"
    },
    {
      "code": "c) **Combining Decorated Code with LangGraph/LangChain** Use a combination of techniques for manual handoff:",
      "language": "unknown"
    },
    {
      "code": "### Context propagation using threading\n\nIt's common to start tracing and want to apply some parallelism on child tasks all within a single trace. Python's stdlib `ThreadPoolExecutor` by default breaks tracing.\n\n#### Why\n\nPython's contextvars start empty within new threads. Here are two approaches to handle maintain trace contiguity:\n\n#### To resolve\n\n1. **Using LangSmith's ContextThreadPoolExecutor**\n\n   LangSmith provides a `ContextThreadPoolExecutor` that automatically handles context propagation:",
      "language": "unknown"
    },
    {
      "code": "2. **Manually providing the parent run tree**\n\n   Alternatively, you can manually pass the parent run tree to the inner function:",
      "language": "unknown"
    }
  ],
  "headings": [
    {
      "level": "h2",
      "text": "Python",
      "id": "python"
    },
    {
      "level": "h3",
      "text": "Context propagation using asyncio",
      "id": "context-propagation-using-asyncio"
    },
    {
      "level": "h3",
      "text": "Context propagation using threading",
      "id": "context-propagation-using-threading"
    }
  ],
  "url": "llms-txt#troubleshoot-trace-nesting",
  "links": []
}